---
- name: vpc security group | docnow-public-jumpbox
  ec2_group:
    name: 'jumpbox ssh access'
    description: 'jumpbox ssh access'
    vpc_id: '{{ vpc_id }}'
    region: '{{ region }}'
    aws_access_key: '{{ aws_access_key }}'
    aws_secret_key: '{{ aws_secret_key }}'
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        cidr_ip: '{{ my_ip }}/32'  # Your private ip
  register: docnow_public_jumpbox

- name: output of jumpbox group
  debug:
    msg: '{{ docnow_public_jumpbox }}'

- name: vpc security group | set group name in variable
  set_fact:
    jumpbox_group: '{{ docnow_public_jumpbox.group_id }}'

- name: vpc security group | docnow-private-applications
  ec2_group:
    name: 'docnow private applications'
    description: "Network for internal app servers"
    vpc_id: '{{ vpc_id }}'
    aws_access_key: '{{ aws_access_key }}'
    aws_secret_key: '{{ aws_secret_key }}'
    rules:
      - proto: tcp
        from_port: 22
        to_port: 22
        group_id: '{{ jumpbox_group }}'
      - proto: tcp
        from_port: 80
        to_port: 80
        group_id: '{{ loadbalancer_group }}'
      - proto: tcp
        from_port: 443
        to_port: 443
        group_id: '{{ loadbalancer_group }}'
      - proto: icmp
        from_port: -1  # icmp type, -1 = any type
        to_port: -1  # icmp subtype, -1 = any subtype
        group_id: '{{ jumpbox_group }}'
