---
- name: Security Group |  upload your rsa key
  ec2_key:
      name: '{{ keypair }}'
      region: '{{ region }}'
      key_material: '{{ item }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
  with_file: ~/.ssh/id_rsa.pub

- name: Security Group | create SSH group
  ec2_group:
      name: 'external ssh access'
      description: 'external ssh access'
      vpc_id: '{{ vpc_id }}'
      region: '{{ region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      rules:
          - proto: 'tcp'
            from_port: '22'
            to_port: '22'
            cidr_ip: '{{ my_ip }}/32'
  register: docnow_main_sg

- name: Security Group |  set docnow main security group ID
  set_fact:
      main_sg_id: '{{ docnow_main_sg.group_id }}'

- name: Security Group | create private security Group
  ec2_group:
      name: 'private instances security group'
      description: 'private instances security group'
      vpc_id: '{{ vpc_id }}'
      region: '{{ region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      rules:
          - proto: 'tcp'
            from_port: '22'
            to_port: '22'
            cidr_ip: '{{ my_ip }}/32'
            group_id: '{{ main_sg_id }}'

- include_tasks: loadbalance.yml
- include_tasks: jumpbox.yml
- include_tasks: elasticsearch.yml
